<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #f5f5f5;
        }
        .navbar {
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a90e2;
        }
        .nav-links {
            display: flex;
            gap: 1rem;
        }
        .nav-links a {
            color: #333;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        .nav-links a:hover {
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .stat-card h3 {
            color: #666;
            margin-bottom: 0.5rem;
        }
        .stat-card p {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }
        .orders-table {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Admin Dashboard</div>
        <div class="nav-links">
            <a href="index.html">Back to Home</a>
        </div>
    </nav>

    <div class="container">
        <div class="stats-container" id="stats-container">
            <!-- Stats will be loaded here -->
        </div>
        <div class="orders-table">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <!-- Orders will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Check if user is admin
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Check admin status
        fetch('http://localhost:3000/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(userData => {
            console.log('User data:', userData);
            if (!userData.success || !userData.data.role || userData.data.role.name !== 'admin') {
                alert('You do not have permission to access this page');
                window.location.href = 'index.html';
                return;
            }
            // User is admin, load dashboard data
            loadDashboard();
        })
        .catch(error => {
            console.error('Error checking admin status:', error);
            window.location.href = 'login.html';
        });

        // Load admin dashboard data
        function loadDashboard() {
            document.getElementById('stats-container').innerHTML = '<div class="loading">Loading statistics...</div>';
            document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="6" class="loading">Loading orders...</td></tr>';

            // Load statistics
            fetch('http://localhost:3000/orders/statistics', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('stats-container').innerHTML = `
                        <div class="stat-card">
                            <h3>Total Orders</h3>
                            <p>${stats.totalOrders}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <p>$${stats.totalRevenue.toFixed(2)}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Completed Orders</h3>
                            <p>${stats.ordersByStatus.find(s => s._id === 'Completed')?.count || 0}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Orders</h3>
                            <p>${stats.ordersByStatus.find(s => s._id === 'Pending')?.count || 0}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('stats-container').innerHTML = '<div class="error">Error loading statistics</div>';
                console.error('Error loading statistics:', error);
            });

            // Load orders
            fetch('http://localhost:3000/orders', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const orders = data.data;
                    document.getElementById('orders-table-body').innerHTML = orders.map(order => `
                        <tr>
                            <td>${order._id}</td>
                            <td>${order.user.username}</td>
                            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                            <td>$${order.totalAmount.toFixed(2)}</td>
                            <td>
                                <span class="status-badge status-${order.orderStatus.toLowerCase()}">
                                    ${order.orderStatus}
                                </span>
                            </td>
                            <td>
                                <button onclick="viewOrderDetails('${order._id}')">View Details</button>
                            </td>
                        </tr>
                    `).join('');
                }
            })
            .catch(error => {
                document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="6" class="error">Error loading orders</td></tr>';
                console.error('Error loading orders:', error);
            });
        }

        function viewOrderDetails(orderId) {
            fetch(`http://localhost:3000/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.data;
                    let detailsHTML = `
                        <div style="padding: 20px;">
                            <h2>Order Details</h2>
                            <p><strong>Order ID:</strong> ${order._id}</p>
                            <p><strong>Customer:</strong> ${order.user.username}</p>
                            <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                            <p><strong>Status:</strong> ${order.orderStatus}</p>
                            <p><strong>Total Amount:</strong> $${order.totalAmount.toFixed(2)}</p>
                            <h3>Items:</h3>
                            <ul>
                    `;

                    order.items.forEach(item => {
                        detailsHTML += `
                            <li>
                                ${item.product.name} - 
                                Quantity: ${item.quantity} - 
                                Price: $${item.price.toFixed(2)}
                            </li>
                        `;
                    });

                    detailsHTML += `
                            </ul>
                        </div>
                    `;

                    alert(detailsHTML);
                }
            })
            .catch(error => {
                console.error('Error loading order details:', error);
            });
        }
    </script>
</body>
</html> 